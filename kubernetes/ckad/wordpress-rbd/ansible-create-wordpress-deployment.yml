#!~/.local/bin/ansible-playbook
---

- name: deploy kubernetes wordpress php7.3-fpm
  hosts: localhost
  connection: local
  serial: 1
  gather_facts: false
  become: false
  collections:
    - community.kubernetes
  tasks:
    - name: Create wordpress namespace
      k8s:
        name: wordpress
        api_version: v1
        kind: Namespace
        state: present

    - name: Create mysql db deployment from file mysql.yaml
      k8s:
        state: present
        src: mysql.yaml

    - name: Create PersistentVolumeClaim for wordpress
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: wp-pv-claim
            namespace: wordpress
            labels:
              app: wordpress
          spec:
            storageClassName: rook-ceph-block
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 5Gi

    - name: Create wordpress-secrets from file
      k8s:
        state: present
        src: wordpress-secrets.yml

    - name: Create Deployment wordpress-php7.3-fpm
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: wordpress-php7.3-fpm
            namespace: wordpress
            labels:
              app: wordpress
          spec:
            selector:
              matchLabels:
                app: wordpress
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: wordpress
              spec:
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                          - arm64
                volumes:
                - name: wordpress-persistent-storage
                  persistentVolumeClaim:
                    claimName: wp-pv-claim
                containers:
                - image: registry.fritz.box/arm64v8/wordpress-php7.3-fpm
                  name: wordpress
                  envFrom:
                  - secretRef:
                      name: wordpress-secrets
                  ports:
                  - containerPort: 9000
                    name: https
                  volumeMounts:
                  - name: wordpress-persistent-storage
                    mountPath: /var/www/html

    - name: Create Service for wordpress on port 9000
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: wordpress
            namespace: wordpress
            labels:
              app: wordpress
          spec:
            selector:
              app: wordpress
            ports:
            - protocol: TCP
              targetPort: 9000
              name: https
              port: 9000

    - name: create nginx configmap from directory
      shell: kubectl --namespace=wordpress create configmap nginx-configmap --from-file=etc-nginx

    - name: Create nginx reverse proxy Deployment
      k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            labels:
              app: nginx
            name: nginx-reverse-proxy
            namespace: wordpress
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nginx
            template:
              metadata:
                labels:
                  app: nginx
              spec:
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                      - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                          - arm64
                volumes:
                - name: nginx-config-volume
                  configMap:
                    name: nginx-configmap
                containers:
                - image: registry.fritz.box/arm64v8/nginx
                  name: nginx
                  ports:
                    - containerPort: 80
                      name: http
                    - containerPort: 443
                      name: https
                  volumeMounts:
                    - name: nginx-config-volume
                      mountPath: /etc/nginx
                      readOnly: false
                  livenessProbe:
                    httpGet:
                      path: /
                      port: http
                      scheme: HTTP
                      httpHeaders:
                        - name: Host
                          value: wordpress.example.com
                    initialDelaySeconds: 3
                    periodSeconds: 60

